# This is a workflow managed by the lambda process
# Do not edit this file directly! It can be overwritten
# Visit https://github.com/trilogy-group/lambda-process/tree/master/github-lambda-process
# Make sure that all required secrets are present in the repository

name: Check Jira ticket
on:
  pull_request:
    types: [ opened, edited, reopened, synchronize ]
  workflow_dispatch:

jobs:
  check-jira-ticket:
    name: Check Jira ticket
    runs-on: ubuntu-latest
    if: ${{github.event.pull_request.user.type != 'Bot'}}
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: configure-npm
        run: |
          npm config set //npm.pkg.github.com/:_authToken ${{ secrets.GH_PACKAGES_TOKEN }}
          npm config set @trilogy-group:registry https://npm.pkg.github.com
          npm i @trilogy-group/lambda-process@latest
      - name: check-jira-ticket
        uses: actions/github-script@v6
        with:
          script: |
            const checkTicket = require("@trilogy-group/lambda-process/checkTicket");
            const { owner, repo } = context.repo;
            const jiraToken = Buffer.from("${{secrets.JIRA_MILOS_AUTH}}").toString('base64');
            const checkTicketResult = await checkTicket.check(${{toJson(github.event.pull_request)}}, jiraToken, owner, repo);
            if (checkTicketResult.error) {
              core.setFailed(checkTicketResult.error);
            }
